SELECT COALESCE((regexp_split_to_array(form.doc #>> '{fields,geolocation}'::text[], ' '::text))[1], form.doc #>> '{fields,location,lat}'::text[]) AS "inputs/meta/location/lat",
   COALESCE((regexp_split_to_array(form.doc #>> '{fields,geolocation}'::text[], ' '::text))[2], form.doc #>> '{fields,location,long}'::text[]) AS "inputs/meta/location/long",
   form.doc #>> '{fields,inputs,source}'::text[] AS "inputs/source",
   form.doc #>> '{fields,inputs,source_id}'::text[] AS "inputs/source_id",
   form.doc #>> '{fields,inputs,t_follow_up_type}'::text[] AS "inputs/t_follow_up_type",
   form.doc #>> '{fields,inputs,t_follow_up_count}'::text[] AS "inputs/t_follow_up_count",
   COALESCE(form.doc #>> '{fields,inputs,contact,_id}'::text[], patient.doc ->> '_id'::text) AS "inputs/contact/_id",
   COALESCE(form.doc #>> '{fields,inputs,contact,name}'::text[], patient.doc ->> 'name'::text) AS "inputs/contact/name",
   COALESCE(form.doc #>> '{fields,inputs,contact,date_of_birth}'::text[], patient.doc ->> 'date_of_birth'::text) AS "inputs/contact/date_of_birth",
   form.doc #>> '{fields,inputs,contact,parent,contact,phone}'::text[] AS "inputs/contact/parent/contact/phone",
   form.doc #>> '{fields,patient_contact_phone}'::text[] AS patient_contact_phone,
   COALESCE(form.doc #>> '{fields,inputs,contact,_id}'::text[], patient.doc ->> '_id'::text) AS patient_id,
   COALESCE(form.doc #>> '{fields,inputs,contact,name}'::text[], patient.doc ->> 'name'::text) AS patient_name,
   form.doc #>> '{fields,referral_follow_up_needed}'::text[] AS referral_follow_up_needed,
   form.doc #>> '{fields,follow_up_count}'::text[] AS follow_up_count,
   form.doc #>> '{fields,danger_signs}'::text[] AS danger_signs,
   form.doc #>> '{fields,patient_improved}'::text[] AS patient_improved,
   form.doc #>> '{fields,patient_better}'::text[] AS patient_better,
   form.doc #>> '{fields,patient_health_facility_visit}'::text[] AS patient_health_facility_visit,
   form.doc #>> '{fields,patient_age_in_days}'::text[] AS patient_age_in_days,
   form.doc #>> '{fields,patient_age_in_years}'::text[] AS patient_age_in_years,
   form.doc #>> '{fields,patient_age_in_months}'::text[] AS patient_age_in_months,
   form.doc #>> '{fields,form_source_id}'::text[] AS form_source_id,
   form.doc #>> '{fields,p_note}'::text[] AS p_note,
   form.doc #>> '{fields,group_followup_options,follow_up_type}'::text[] AS follow_up_type,
   form.doc #>> '{fields,group_followup_options,follow_up_method}'::text[] AS follow_up_method,
   form.doc #>> '{fields,group_followup_options,call_button1}'::text[] AS call_button1,
   form.doc #>> '{fields,group_followup_options,call_button2}'::text[] AS call_button2,
   form.doc #>> '{fields,group_danger_signs,danger_signs_note}'::text[] AS danger_signs_note,
   form.doc #>> '{fields,group_danger_signs,g_danger_signs}'::text[] AS g_danger_signs,
   form.doc #>> '{fields,group_danger_signs,danger_signs_referral}'::text[] AS danger_signs_referral,
   form.doc #>> '{fields,group_improved,g_patient_treatment_outcome}'::text[] AS g_patient_treatment_outcome,
   form.doc #>> '{fields,group_improved,g_patient_improved}'::text[] AS g_patient_improved,
   form.doc #>> '{fields,group_improved,patient_improved_yes}'::text[] AS patient_improved_yes,
   form.doc #>> '{fields,group_improved,patient_improved_no}'::text[] AS patient_improved_no,
   form.doc #>> '{fields,group_referral_followup,g_patient_health_facility_visit}'::text[] AS g_patient_health_facility_visit,
   form.doc #>> '{fields,group_referral_followup,no_facility_visit}'::text[] AS no_facility_visit,
   form.doc #>> '{fields,group_better,g_patient_better}'::text[] AS g_patient_better,
   form.doc #>> '{fields,group_better,patient_better_yes}'::text[] AS patient_better_yes,
   form.doc #>> '{fields,group_better,patient_better_no}'::text[] AS patient_better_no,
   ''::text AS "meta/instanceID",
   form.doc ->> '_id'::text AS xmlforms_uuid,
  to_timestamp((NULLIF(form.doc ->> 'reported_date', '')::bigint / 1000)::double precision) AS reported
  FROM {{ ref("couchdb") }} form
    JOIN {{ ref("form_metadata") }} fm ON fm.uuid = (form.doc ->> '_id'::text)
    LEFT JOIN {{ ref("couchdb") }} patient ON (patient.doc ->> '_id'::text) = (form.doc #>> '{fields,patient_id}'::text[])
 WHERE form.doc->>'type' = 'data_record' AND (form.doc ->> 'form'::text) = 'assessment_follow_up'::text